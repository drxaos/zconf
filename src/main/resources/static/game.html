<div>
<pre id="map" style="font-size: 20px; color: green">
<span style="color: red">L</span>OA<span style="color: yellow">D</span>I<span style="color: lime">N</span>G.<span
        style="color: #004400">.</span><span style="color: #002200">.</span>
</pre>
</div>

<style>
    body, html {
        background-color: black;
    }

    div {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .active {
        outline: 1px solid gold;
    }
</style>

<script>
    var ajax = function (url, callback) {
        var xmlHTTP = new XMLHttpRequest();
        xmlHTTP.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200)
                callback && callback(this.responseText);
        };
        xmlHTTP.open("GET", url, true);
        xmlHTTP.send();
    };

    var key = "";
    var w = 0, h = 0, s1 = 0, s2 = 0, id = 0, kd = 0;
    var rating = [];

    if (document.addEventListener) {
        document.addEventListener("keydown", keyCapt, false);
    } else {
        document.attachEvent("onkeydown", keyCapt);
    }

    function keyCapt(e) {
        if (!key || id === 0 || w === 0 || h === 0) {
            return true;
        }
        if (typeof window.event != "undefined") {
            e = window.event;
        }
        if (e.type == "keydown") {
            if (e.keyCode >= 37 && e.keyCode <= 40) {
                kd = e.keyCode;
            } else {
                return true;
            }
        }
        e.preventDefault();
        e.stopPropagation();
        return false;
    }

    var p = document.getElementById("map");

    setInterval(function () {

        var k = document.getElementById("key");

        if (!key && !k) {
            var s = "";
            s += "╓─────[API ACCESS]─────╖\n";
            s += "║                      ║\n";
            s += "║ KEY [" +
                "<input autofocus id='key' type='password' maxlength='14' style='width: 10.54rem;height: 20px;padding:0;border:none;outline:none;font-size: 20px;color: green;background-color: #111;font-family:Consolas,Monaco,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New, monospace;'/>" +
                "] ║\n";
            s += "║                      ║\n";
            s += "╙──────────────────────╜\n";
            p.innerHTML = s;
            return;
        }

        if (!key) {
            var kv = k.value;
            if (kv && kv.length > 0) {
                ajax("/auth/" + kv, function (data) {
                    var d = JSON.parse(data);
                    if (d > 0) {
                        key = kv;
                        id = d;
                    }
                });
            }
            return;
        }

        if (w === 0 || h === 0) {
            ajax("/size/" + key, function (data) {
                var d = JSON.parse(data);
                w = d[0];
                h = d[1];
            });
            return;
        }
        ajax("/score/" + key, function (data) {
            var d = JSON.parse(data);
            s1 = d[0];
            s2 = d[1];
        });
        ajax("/rating/" + key, function (data) {
            var d = JSON.parse(data);
            rating = d.map(function (scor, idx) {
                return {z: idx + 100, s: scor};
            }).filter(function (e) {
                return e.s > 0;
            }).sort(function (a, b) {
                return a.s === b.s ? a.z - b.z : b.s - a.s;
            });
        });

        if (kd > 0) {
            if (kd === 37) {
                ajax("/left/" + key);
            } else if (kd === 38) {
                ajax("/up/" + key);
            } else if (kd === 39) {
                ajax("/right/" + key);
            } else if (kd === 40) {
                ajax("/down/" + key);
            }
            kd = 0;
            return;
        }

        ajax("/look/" + key, function (data) {
            var map = JSON.parse(data);
            if (!(map instanceof Array)) {
                return;
            }

            var s = "";
            s += "╓";

            var x, y;
            for (x = 0; x < w; x++) {
                s += "─";
            }
            s += "╥──────[<span style='color: lime'>Зайцы и капуста</span>]──────╖";

            s += "\n";
            for (y = 0; y < h; y++) {
                s += "║";
                for (x = 0; x < w; x++) {

                    var xy = x + y * w;
                    var o = map[xy];
                    switch (o) {
                        case 0:
                            s += ".";
                            break;
                        case 1:
                            s += "<span style='color: red;'>#</span>";
                            break;
                        case 2:
                            s += "<span style='color: lime;'>$</span>";
                            break;
                        case 10:
                            s += "<span style='color: white;'>O</span>";
                            break;
                        case 20:
                            s += "<span style='color: darkgray;'>O</span>";
                            break;
                        default:
                            if (o >= 100 && o < 200) {
                                s += "<span style='color: white;' " + (o === id ? 'class="active"' : '') + ">Z</span>";
                            } else if (o >= 200 && o < 300) {
                                s += "<span style='color: darkgray;' " + (o === id ? 'class="active"' : '') + ">Z</span>";
                            }
                            break;
                    }

                }
                s += "║";

                if (y === 1 && s1 >= s2 || y === 2 && s2 > s1) {
                    s += "  <span style='color: white'>БЕЛЫЕ</span>  <span style='color: lime'>" + s1 + "</span>"
                }
                if (y === 1 && s1 < s2 || y === 2 && s2 <= s1) {
                    s += "  <span style='color: darkgray'>СЕРЫЕ</span>  <span style='color: lime'>" + s2 + "</span>"
                }
                if (y >= 4 && rating.length > y - 4) {
                    s += "  <span style='color: " + (rating[y - 4].z < 200 ? "white" : "darkgray") + "'>Z" + rating[y - 4].z + "</span>  <span style='color: lime'>" + rating[y - 4].s + "</span>";
                }
                var text = s.replace(/(<([^>]+)>)/ig, "");
                var spaces = text.indexOf("\n") - (text.length - text.lastIndexOf("\n"));
                for (var i = 0; i < spaces; i++) {
                    s += " ";
                }
                s += "║\n";
            }

            s += "╙";

            for (x = 0; x < w; x++) {
                s += "─";
            }
            s += "╨";

            var text = s.replace(/(<([^>]+)>)/ig, "");
            var spaces = text.indexOf("\n") - (text.length - text.lastIndexOf("\n"));
            for (var i = 0; i < spaces; i++) {
                s += "─";
            }
            s += "╜";

            p.innerHTML = s;
        });
    }, 200);
</script>

